---
title: 图形学篇
date: 2024-02-24
tags:
  - 面试题合集
---

## 渲染管线

[TheTus Games101笔记](https://www.yuque.com/gaoshanliushui-mbfny)
[游戏开发面经汇总-图形学基础篇-Steven王​](https://zhuanlan.zhihu.com/p/499548836)
[投影变换与MVP|第五期](https://www.bilibili.com/video/BV1C3411H7Hu

###  Games101

#### 图形渲染管线

![](/images/posts/1694782558351-f1be0b4c-737e-4845-9efa-e4d28fbe32fc.png)

#### 顶点处理

![](/images/posts/1694782558443-ae1a0d35-ef2d-470c-b1d7-c71c175767d1.png)
顶点处理的作用是对所有顶点数据进行MVP变换，最终得到投影到二维平面的坐标信息（同时为了Zbuffer保留深度z值）。超出观察空间的会被剪裁掉。

#### 三角形阶段

三角形处理十分容易理解，就是将所有的顶点按照原几何信息，变成三角面，每个面由3个顶点组成。

#### 光栅化

![](/images/posts/1694782558555-336a18e9-7f3f-452e-8bc1-c90f1478a10d.png)
得到了许许多多个三角形之后，接下来的操作自然就是三角形光栅化了。

#### 片元阶段

![](/images/posts/1694782559078-1c201015-8d36-471e-b91b-3af999346fd9.png)
![](/images/posts/1694782559149-7157ae3e-2efa-4bb9-bc75-6a8edf3194a2.png)
![](/images/posts/1694782559424-eb7bf10a-4d43-4db4-9315-adae5e5fcc57.png)
在进行完三角形的光栅化之后，知道了哪些在三角形内的点可以被显示，那么如何确定每个像素点或者说片元(Fragement)的颜色呢？[注：片元可能比像素更小，如MSAA抗拒齿操作的进一步细分得到的采样点]。那自然就是着色了，也就是片元处理阶段应该做的。
注意这阶段顶点处理也亮起来是因为我们需要顶点信息对三角形内的点进行属性插值(tips：当然也可以直接在顶点处理阶段就算出每个顶点的颜色值，如Gouraud Shading一样)。当然这一阶段也少不了Z-Buffer来帮助确定，哪些像素点应该显示在屏幕上，哪些点被遮挡了不应该显示
片元处理中，还有纹理映射的步骤。

#### Framebuffer处理

将所有的像素颜色信息整合在一起，输送给显示设备加以显示。这也就完成了整个图形渲染管线了。


### Steven王​

图形渲染管线是图形学知识考察最重要的一个问题，绝对是最高频的，必须掌握。问法有很多种，比如屏幕中一个像素是怎么绘制出来的，绘制出一幅图像的具体过程等。此外还有GPU渲染管线的问法，其实就是省去CPU阶段，直接从GPU阶段开始回答就行了，是一个意思。

【**Reference**】：《Real Time Rendering 4th》Chapter 2；《游戏引擎架构》P404；[细说图形学渲染管线.pdf (positiveczp.github.io)](https://link.zhihu.com/?target=https%3A//positiveczp.github.io/%25E7%25BB%2586%25E8%25AF%25B4%25E5%259B%25BE%25E5%25BD%25A2%25E5%25AD%25A6%25E6%25B8%25B2%25E6%259F%2593%25E7%25AE%25A1%25E7%25BA%25BF.pdf)；[猴子也能看懂的渲染管线（Render Pipeline） - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/137780634)；[渲染管线中的不可控、可配置与可控 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/87508234)

（注：第一本神书就不说了，可以去看英文原版或者等明年的中译版(译者是我们组长)，第二本也是经典书籍，非常值得一看；其余这三篇文章也都写得很好，第一篇最详细，第二篇最通俗易懂，第三篇最底层，详细看完这三篇文章应该对图形渲染管线的理解就没问题了，需要注意的是这三篇文章有些地方会有些出入，遇到疑惑的地方还是以RTR4的描述为主）

**1.1 什么是图形渲染管线，分为哪些阶段？(⭐⭐⭐)**

图形渲染管线实际上指的是一堆原始图形数据途经一个输送管道，期间经过各种变化处理最终出现在屏幕的过程，在概念上可以将图形渲染管线分为四个阶段：应用程序阶段、几何阶段、光栅化阶段和像素处理阶段。

![f46n7](/images/posts/f46n7.jpg)

图形渲染管线

（1）应用程序阶段的主要任务，是识别出潜在可视的网格实例，并把它们及其材质呈交至图形硬件以供渲染。该阶段包含三大任务：可见性判断、控制着色器参数和渲染状态、提交图元至GPU硬件以供渲染。

（注：应用程序阶段在**CPU**端完成，后面的所有阶段都是在**GPU**端完成）

（2）几何阶段主要负责大部分多边形操作和顶点操作，将三维空间的数据转换为二维空间的数据，可以分为顶点着色、投影变换、裁剪和屏幕映射阶段。

（3）光栅化阶段是将图元离散化成片段的过程，其任务是找到需要绘制出的所有片段，包括三角形设定(图元装配)和三角形遍历阶段；

（4）像素处理阶段，给每一个像素正确配色，最后绘制出整幅图像，包括像素着色和合并阶段。

**1.2 请详细描述图形渲染管线每个阶段的具体任务？(⭐⭐⭐)**

（1）应用程序阶段，该阶段主要是在软件层面上执行的一些工作，包括空间加速算法、视锥剔除、碰撞检测、动画物理模拟等。大体逻辑是：执行视锥剔除，查询出可能需要绘制的图元并生成渲染数据，设置渲染状态和绑定各种Shader参数，调用DrawCall，进入到下一个阶段，GPU渲染管线。

（2）几何阶段，包含顶点着色、投影变换、裁剪和屏幕映射阶段。

注意，虽然在RTR4中几何阶段将顶点着色和投影变化分开了，但这两者都是在顶点着色器中完成的，为了方便理解我们可以统一称为**顶点处理阶段**。

a. 顶点处理阶段：这个阶段会执行**顶点变换**和**顶点着色**的工作。通过模型矩阵、观察矩阵和投影矩阵(也就是MVP矩阵)计算出顶点在裁剪空间下的位置(clip space)，以便后续阶段转化为标准化设备坐标系(NDC)下的位置。也可能会计算出顶点的法线(需要有法线变换矩阵)和纹理坐标等。同时，在这个阶段也可能会进行顶点的着色计算，如平面着色 (Flat Shading)和高洛德着色 (Gouraud Shading)都是在顶点着色器中进行着色计算。因为这个阶段是完全可控制的，因此执行什么样的操作由程序员来决定。（此外，在顶点处理阶段的末尾，还有一些可选的阶段，包括曲面细分(tessellation)、几何着色(geometry shading)和流输出(stream output)，此处不详细描述）

b. 裁剪阶段：对部分不在视体内部的图元进行裁剪。这部分是几乎完全由硬件控制的，因此没必要详细描述，至于为什么有了视锥剔除，到这个阶段还需要进行一次裁剪，可参考这个问题[为什么在ndc归一化坐标已经包含了视锥体剔除功能的情况下 还需要视锥体裁剪？ - 知乎 (zhihu.com)](https://www.zhihu.com/question/304277310/answer/562221670)。简单来说就是两次裁剪的粒度不同，前者是在物体对象层面的，一般对对象的包围盒做剔除，剔除掉不在视锥体内的物体，NDC裁剪是在三角形层面做的，裁剪掉不在屏幕内的像素。

![ygk6l](/images/posts/ygk6l.jpg)

裁剪

c. 屏幕映射阶段：主要目的是将之前步骤得到的坐标映射到对应的屏幕坐标系上。

![hmqxe](/images/posts/hmqxe.jpg)

屏幕映射

（3）光栅化阶段，包含三角形设置和三角形遍历阶段。

![1xroa](/images/posts/1xroa.jpg)

光栅化

a. 三角形设置(图元装配)，计算出三角形的一些重要数据(如三条边的方程、深度值等)以供三角形遍历阶段使用，这些数据同样可用于各种着色数据的插值。

b. 三角形遍历，找到哪些像素被三角形所覆盖，并对这些像素的属性值进行插值。通过判断像素的中心采样点是否被三角形覆盖来决定该像素是否要生成片段。通过三角形三个顶点的属性数据，插值得到每个像素的属性值。此外透视校正插值也在这个阶段执行。

这两个阶段是完全硬件控制的，不可进行任何操作。

（4）**像素处理阶段**，包括像素着色和测试合并。

a. 像素着色，进行光照计算和阴影处理，决定屏幕像素的最终颜色。各种复杂的着色模型、光照计算都是在这个阶段完成。

b. 测试合并，包括各种测试和混合操作，如裁剪测试、透明测试、模板测试、深度测试以及色彩混合等。经过了测试合并阶段，并存到帧缓冲的像素值，才是最终呈现在屏幕上的图像。

（5）各个阶段的可控性

![2qq4b](/images/posts/2qq4b.jpg)

各阶段可控性

## MVP 变换推导

>再提一嘴，齐次坐标使得矩阵的位移变换可以由乘积得到

[MVP 变换推导](随手记/MVP%20变换推导.md)
## 深度测试

## 法线贴图

